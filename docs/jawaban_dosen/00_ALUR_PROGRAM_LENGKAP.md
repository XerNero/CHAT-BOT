# ğŸ”„ ALUR PROGRAM LENGKAP

## Pertanyaan Dosen
> "Coba jelaskan alur program ini dari awal sampai akhir secara lengkap!"

---

## ğŸ¯ Overview Arsitektur

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ARSITEKTUR SISTEM RAG                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                       FASE 1: DATA INGESTION                         â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  PDF Upload â†’ Extract â†’ Chunk â†’ Embed â†’ Store to Qdrant             â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                       FASE 2: QUERY PROCESSING                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚     SINGLE-HOP      â”‚    â”‚           MULTI-HOP                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚    â”‚                                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Query â†’ Retrieve   â”‚    â”‚  Query â†’ Decompose â†’ 4x Retrieve   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â†’ Generate Answer  â”‚    â”‚  â†’ Merge â†’ Generate Answer          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚    â”‚                                      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  KOMPONEN:                                                                   â”‚
â”‚  â”œâ”€â”€ LLM (llama3:8b via Ollama) - Embedding + Chat                         â”‚
â”‚  â”œâ”€â”€ Qdrant - Vector Database                                               â”‚
â”‚  â”œâ”€â”€ Hybrid Retrieval - Vector Search + BM25 + RRF                         â”‚
â”‚  â””â”€â”€ Fastify - Backend Server                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ“¥ FASE 1: DATA INGESTION

## Alur Ingestion Lengkap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATA INGESTION FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  STEP 1: PDF UPLOAD                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  User upload: peraturan_akademik.pdf (2MB)                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Endpoint: POST /ingest                                              â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 637-705                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 2: PDF PARSING (Extract Text)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Library: pdf-parse                                                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  const pdfData = await pdfParse(buffer);                             â”‚   â”‚
â”‚  â”‚  const fullText = pdfData.text;  // ~50,000 karakter                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 674                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 3: SMART CHUNKING                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Fungsi: chunkText(fullText, 800, 150)                               â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Features:                                                           â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Split per PARAGRAF (bukan per karakter)                        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Deteksi HEADING (BAB, Pasal, Artikel)                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Max 800 karakter per chunk                                     â”‚   â”‚
â”‚  â”‚  â””â”€â”€ OVERLAP 150 karakter                                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Output: ~60 chunks                                                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 81-156                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 4: EMBEDDING (LLM #1)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Untuk SETIAP chunk:                                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  const vec = await embedWithOllama(chunk);                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Input: "Syarat yudisium adalah lulus semua MK..."                  â”‚   â”‚
â”‚  â”‚  Output: [0.123, -0.456, 0.789, ...] (4096 dimensi)                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Model: llama3:8b                                                    â”‚   â”‚
â”‚  â”‚  API: POST http://localhost:11434/api/embeddings                    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 158-176, 686-688                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 5: STORE TO QDRANT                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  await qdrant.upsert(COLLECTION_NAME, {                              â”‚   â”‚
â”‚  â”‚    points: [                                                         â”‚   â”‚
â”‚  â”‚      {                                                               â”‚   â”‚
â”‚  â”‚        id: 1,                                                        â”‚   â”‚
â”‚  â”‚        vector: [0.123, -0.456, ...],  // 4096 dimensi               â”‚   â”‚
â”‚  â”‚        payload: {                                                    â”‚   â”‚
â”‚  â”‚          source_file: "peraturan_akademik.pdf",                     â”‚   â”‚
â”‚  â”‚          text: "Syarat yudisium adalah..."                          â”‚   â”‚
â”‚  â”‚        }                                                             â”‚   â”‚
â”‚  â”‚      },                                                              â”‚   â”‚
â”‚  â”‚      // ... 59 chunks lainnya                                       â”‚   â”‚
â”‚  â”‚    ]                                                                 â”‚   â”‚
â”‚  â”‚  });                                                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 691-695                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 6: BUILD BM25 CACHE                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Setelah upsert, rebuild cache untuk BM25:                          â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  await rebuildKeywordCache();                                        â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Cache berisi:                                                       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Semua chunks (points)                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Document Frequency (df) setiap kata                            â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Average Document Length (avgdl)                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 191-243                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  âœ… DATA SIAP UNTUK QUERY!                                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ” FASE 2A: SINGLE-HOP QUERY

## Alur Single-hop Lengkap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SINGLE-HOP QUERY FLOW                               â”‚
â”‚                          Endpoint: POST /chat                                â”‚
â”‚                          ğŸ“ Baris: 707-816                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  User: "Apa syarat yudisium?"                                               â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 1: EMBEDDING QUERY (LLM #1)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  const qVec = await embedWithOllama("Apa syarat yudisium?");         â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Output: [0.15, -0.42, 0.81, ...] (4096 dimensi)                    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 437 (dalam hybridRetrieve)                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                                                      â”‚             â”‚
â”‚         â–¼                                                      â–¼             â”‚
â”‚  STEP 2A: VECTOR SEARCH                        STEP 2B: BM25 SEARCH         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  qdrant.search({            â”‚              â”‚  Untuk setiap chunk:        â”‚â”‚
â”‚  â”‚    vector: qVec,            â”‚              â”‚                             â”‚â”‚
â”‚  â”‚    limit: 16                â”‚              â”‚  score = bm25Score(         â”‚â”‚
â”‚  â”‚  });                        â”‚              â”‚    ["apa","syarat","yudisium"],â”‚â”‚
â”‚  â”‚                             â”‚              â”‚    chunkTokens,             â”‚â”‚
â”‚  â”‚  Hitung: Cosine Similarity  â”‚              â”‚    df, avgdl                â”‚â”‚
â”‚  â”‚                             â”‚              â”‚  );                         â”‚â”‚
â”‚  â”‚  Output:                    â”‚              â”‚                             â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ Chunk 45: score 0.92   â”‚              â”‚  Output:                    â”‚â”‚
â”‚  â”‚  â”œâ”€â”€ Chunk 12: score 0.87   â”‚              â”‚  â”œâ”€â”€ Chunk 45: score 8.5    â”‚â”‚
â”‚  â”‚  â””â”€â”€ ...                    â”‚              â”‚  â”œâ”€â”€ Chunk 78: score 7.2    â”‚â”‚
â”‚  â”‚                             â”‚              â”‚  â””â”€â”€ ...                    â”‚â”‚
â”‚  â”‚  ğŸ“ Baris: 439-448          â”‚              â”‚  ğŸ“ Baris: 450-467          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                                      â”‚             â”‚
â”‚         â”‚  Rank: 1,2,3...                    Rank: 1,2,3...    â”‚             â”‚
â”‚         â”‚                                                      â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 3: RRF FUSION (Reciprocal Rank Fusion)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  const fused = rrfFuse(vectorRank, keywordRank, k=60);               â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Formula: Score(d) = 1/(60 + rank_vector) + 1/(60 + rank_bm25)      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Contoh Chunk 45:                                                    â”‚   â”‚
â”‚  â”‚  - Vector rank: 1 â†’ 1/(60+1) = 0.0164                               â”‚   â”‚
â”‚  â”‚  - BM25 rank: 1 â†’ 1/(60+1) = 0.0164                                 â”‚   â”‚
â”‚  â”‚  - RRF Score = 0.0328 â† TERTINGGI (bagus di kedua metode)           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 311-316, 469                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 4: SELECT TOP-K CHUNKS                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Ambil 8 chunk dengan RRF score tertinggi:                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  contextChunks = [                                                   â”‚   â”‚
â”‚  â”‚    { text: "Syarat yudisium adalah...", score: 0.0328 },            â”‚   â”‚
â”‚  â”‚    { text: "IPK minimal 2.00...", score: 0.0295 },                  â”‚   â”‚
â”‚  â”‚    { text: "Tidak boleh ada nilai E...", score: 0.0271 },           â”‚   â”‚
â”‚  â”‚    // ... 5 chunks lagi                                             â”‚   â”‚
â”‚  â”‚  ]                                                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 721                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 5: BUILD CONTEXT + PROMPT                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  // Format context dengan sitasi                                     â”‚   â”‚
â”‚  â”‚  contextText = "[#1]\nSyarat yudisium adalah...\n\n---\n\n"         â”‚   â”‚
â”‚  â”‚               + "[#2]\nIPK minimal 2.00...\n\n---\n\n"              â”‚   â”‚
â”‚  â”‚               + ...                                                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  // System prompt (anti-halusinasi)                                  â”‚   â”‚
â”‚  â”‚  system = "Kamu adalah asisten kampus berbasis dokumen.              â”‚   â”‚
â”‚  â”‚            ATURAN: Jawab HANYA dari CONTEXT. Pakai sitasi [#N]."    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  // User prompt                                                      â”‚   â”‚
â”‚  â”‚  userPrompt = "PERTANYAAN:\nApa syarat yudisium?\n\n"               â”‚   â”‚
â”‚  â”‚             + "CONTEXT:\n" + contextText                            â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 723-764                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 6: LLM GENERATE ANSWER (LLM #2)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  const chat1 = await ollamaChat([                                    â”‚   â”‚
â”‚  â”‚    { role: "system", content: system },                              â”‚   â”‚
â”‚  â”‚    { role: "user", content: userPrompt }                             â”‚   â”‚
â”‚  â”‚  ], temperature=0.2);                                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Model: llama3:8b                                                    â”‚   â”‚
â”‚  â”‚  API: POST http://localhost:11434/api/chat                          â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 768-780                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 7: VALIDATE + RETRY (Anti-Halusinasi)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  // Cek apakah jawaban punya sitasi                                  â”‚   â”‚
â”‚  â”‚  if (!hasCitations(answer) && !isNotFoundText(answer)) {             â”‚   â”‚
â”‚  â”‚    // RETRY: minta LLM tambahkan sitasi                             â”‚   â”‚
â”‚  â”‚    const chat2 = await ollamaChat(repairMessages, 0.0);              â”‚   â”‚
â”‚  â”‚  }                                                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  // Fallback: paksa tambah sitasi jika masih tidak ada              â”‚   â”‚
â”‚  â”‚  if (!hasCitations(answer)) {                                        â”‚   â”‚
â”‚  â”‚    answer = ensureCitationsInText(answer, "[#1]");                   â”‚   â”‚
â”‚  â”‚  }                                                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 782-807                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 8: RETURN RESPONSE                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  return {                                                            â”‚   â”‚
â”‚  â”‚    reply: "Syarat yudisium meliputi:\n"                             â”‚   â”‚
â”‚  â”‚         + "1. Lulus semua MK wajib [#1]\n"                          â”‚   â”‚
â”‚  â”‚         + "2. IPK minimal 2.00 [#2]\n"                              â”‚   â”‚
â”‚  â”‚         + "3. Tidak ada nilai E [#3]",                              â”‚   â”‚
â”‚  â”‚    chunks: contextChunks  // Untuk transparansi                     â”‚   â”‚
â”‚  â”‚  };                                                                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 809-815                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ”€ FASE 2B: MULTI-HOP QUERY

## Alur Multi-hop Lengkap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MULTI-HOP QUERY FLOW                                â”‚
â”‚                          Endpoint: POST /chat-multihop                       â”‚
â”‚                          ğŸ“ Baris: 823-956                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  User: "Jelaskan proses yudisium lengkap dari syarat sampai wisuda"         â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 1: QUERY DECOMPOSITION (LLM #1)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  const subQueries = await decomposeQuery(question);                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  LLM menerima prompt:                                                â”‚   â”‚
â”‚  â”‚  "Pecah pertanyaan ini jadi 4 sub-query:                            â”‚   â”‚
â”‚  â”‚   1) overview/definisi                                               â”‚   â”‚
â”‚  â”‚   2) detail/poin utama                                               â”‚   â”‚
â”‚  â”‚   3) aturan/batasan                                                  â”‚   â”‚
â”‚  â”‚   4) penutup/tindak lanjut"                                         â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Output:                                                             â”‚   â”‚
â”‚  â”‚  {                                                                   â”‚   â”‚
â”‚  â”‚    "overview": "Apa definisi yudisium?",                            â”‚   â”‚
â”‚  â”‚    "detail": "Apa syarat lengkap yudisium?",                        â”‚   â”‚
â”‚  â”‚    "aturan": "Apa batasan dan larangan dalam yudisium?",            â”‚   â”‚
â”‚  â”‚    "penutup": "Apa yang terjadi setelah yudisium sampai wisuda?"    â”‚   â”‚
â”‚  â”‚  }                                                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 491-543, 831                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚              â”‚           â”‚           â”‚              â”‚             â”‚
â”‚         â–¼              â–¼           â–¼           â–¼              â”‚             â”‚
â”‚  STEP 2: PARALLEL RETRIEVAL (4x Hybrid Search)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  const [overview, detail, aturan, penutup] = await Promise.all([     â”‚   â”‚
â”‚  â”‚    hybridRetrieve(subQueries.overview, 4),   // 4 chunks            â”‚   â”‚
â”‚  â”‚    hybridRetrieve(subQueries.detail, 4),     // 4 chunks            â”‚   â”‚
â”‚  â”‚    hybridRetrieve(subQueries.aturan, 4),     // 4 chunks            â”‚   â”‚
â”‚  â”‚    hybridRetrieve(subQueries.penutup, 4),    // 4 chunks            â”‚   â”‚
â”‚  â”‚  ]);                                                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Total: 16 chunks (sebelum deduplicate)                             â”‚   â”‚
â”‚  â”‚  Parallel: 4 search dijalankan BERSAMAAN (cepat!)                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 834-839                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 3: MERGE + DEDUPLICATE                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  // Gabungkan semua chunks dengan label hop-nya                      â”‚   â”‚
â”‚  â”‚  let allChunks = [                                                   â”‚   â”‚
â”‚  â”‚    ...overview.map(c => ({...c, hop: "overview"})),                 â”‚   â”‚
â”‚  â”‚    ...detail.map(c => ({...c, hop: "detail"})),                     â”‚   â”‚
â”‚  â”‚    ...aturan.map(c => ({...c, hop: "aturan"})),                     â”‚   â”‚
â”‚  â”‚    ...penutup.map(c => ({...c, hop: "penutup"})),                   â”‚   â”‚
â”‚  â”‚  ];                                                                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  // Deduplicate berdasarkan chunk ID                                 â”‚   â”‚
â”‚  â”‚  const seen = new Set();                                             â”‚   â”‚
â”‚  â”‚  allChunks = allChunks.filter(c => {                                â”‚   â”‚
â”‚  â”‚    if (seen.has(c.id)) return false;                                â”‚   â”‚
â”‚  â”‚    seen.add(c.id);                                                  â”‚   â”‚
â”‚  â”‚    return true;                                                      â”‚   â”‚
â”‚  â”‚  });                                                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Hasil: ~10-12 unique chunks                                        â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 841-862                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 4: BUILD CONTEXT WITH HOP LABELS                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  contextText = allChunks                                             â”‚   â”‚
â”‚  â”‚    .map((c, idx) => `[#${idx + 1}] (${c.hop})\n${c.text}`)          â”‚   â”‚
â”‚  â”‚    .join("\n\n---\n\n");                                            â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  Contoh:                                                             â”‚   â”‚
â”‚  â”‚  "[#1] (overview)                                                    â”‚   â”‚
â”‚  â”‚   Yudisium adalah sidang penetapan kelulusan mahasiswa...            â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚   ---                                                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚   [#2] (detail)                                                      â”‚   â”‚
â”‚  â”‚   Syarat yudisium meliputi: 1. Lulus semua MK...                    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚   ---                                                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚   [#3] (aturan)                                                      â”‚   â”‚
â”‚  â”‚   Mahasiswa yang memiliki nilai E tidak dapat yudisium...           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚   ---                                                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚   [#4] (penutup)                                                     â”‚   â”‚
â”‚  â”‚   Setelah yudisium, mahasiswa dapat mendaftar wisuda..."            â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 873-875                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 5: LLM SYNTHESIS (LLM #2)                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  const chat1 = await ollamaChat([                                    â”‚   â”‚
â”‚  â”‚    { role: "system", content: system },                              â”‚   â”‚
â”‚  â”‚    { role: "user", content: userPrompt }                             â”‚   â”‚
â”‚  â”‚  ], temperature=0.2);                                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  LLM menerima:                                                       â”‚   â”‚
â”‚  â”‚  - System prompt (anti-halusinasi)                                   â”‚   â”‚
â”‚  â”‚  - Context dari 4 aspek (overview, detail, aturan, penutup)         â”‚   â”‚
â”‚  â”‚  - Original question                                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  LLM menghasilkan jawaban KOMPREHENSIF yang mencakup                â”‚   â”‚
â”‚  â”‚  semua aspek dengan sitasi [#N]                                     â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 907-920                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  STEP 6: VALIDATE + RETURN                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  // Sama seperti single-hop: validate sitasi, retry jika perlu      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  return {                                                            â”‚   â”‚
â”‚  â”‚    reply: "Proses yudisium dimulai dari:\n\n"                       â”‚   â”‚
â”‚  â”‚         + "**Definisi:**\n"                                         â”‚   â”‚
â”‚  â”‚         + "Yudisium adalah sidang... [#1]\n\n"                      â”‚   â”‚
â”‚  â”‚         + "**Syarat:**\n"                                           â”‚   â”‚
â”‚  â”‚         + "1. Lulus semua MK [#2]\n"                                â”‚   â”‚
â”‚  â”‚         + "2. IPK minimal 2.00 [#2]\n\n"                            â”‚   â”‚
â”‚  â”‚         + "**Aturan:**\n"                                           â”‚   â”‚
â”‚  â”‚         + "Tidak boleh ada nilai E [#3]\n\n"                        â”‚   â”‚
â”‚  â”‚         + "**Setelah Yudisium:**\n"                                 â”‚   â”‚
â”‚  â”‚         + "Dapat mendaftar wisuda [#4]",                            â”‚   â”‚
â”‚  â”‚    chunks: allChunks,                                               â”‚   â”‚
â”‚  â”‚    subQueries: subQueries  // Untuk transparansi                    â”‚   â”‚
â”‚  â”‚  };                                                                  â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  ğŸ“ Baris: 944-955                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ“Š RINGKASAN KOMPONEN

## âš ï¸ PENTING: LLM dan RAG Dipakai di KEDUANYA!

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LLM + RAG = KEDUANYA DIPAKAI!                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        SINGLE-HOP             MULTI-HOP                     â”‚
â”‚                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚                                                                              â”‚
â”‚  LLM #1: Embedding     âœ… Ya (1x)             âœ… Ya (4x)                    â”‚
â”‚  LLM #2: Decompose     âŒ Tidak               âœ… Ya (EXTRA!)                â”‚
â”‚  LLM #3: Generate      âœ… Ya (1x)             âœ… Ya (1x)                    â”‚
â”‚                                                                              â”‚
â”‚  RAG: Hybrid Search    âœ… Ya (1x)             âœ… Ya (4x) â† LEBIH BANYAK!    â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  âŒ SALAH: "Single-hop = RAG, Multi-hop = LLM"                              â”‚
â”‚  âœ… BENAR: "Keduanya pakai LLM + RAG, Multi-hop pakai LEBIH BANYAK"         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Perbandingan Penggunaan Komponen

| Komponen | Single-hop | Multi-hop | Keterangan |
|----------|------------|-----------|------------|
| **LLM: Embedding** | âœ… 1x | âœ… 4x | Multi-hop embed 4 sub-query |
| **LLM: Decompose** | âŒ | âœ… 1x | **HANYA di Multi-hop** |
| **LLM: Generate** | âœ… 1x | âœ… 1x | Sama |
| **RAG: Vector Search** | âœ… 1x | âœ… 4x | Multi-hop 4x search |
| **RAG: BM25** | âœ… 1x | âœ… 4x | Multi-hop 4x search |
| **RAG: RRF** | âœ… 1x | âœ… 4x | Multi-hop 4x fusion |
| **Total LLM calls** | 2 | 6 | embed + (decompose) + generate |
| **Total RAG calls** | 1 | 4 | Hybrid search count |

---

## LLM (Large Language Model)

| Penggunaan                | Fungsi                    | Baris   | API               | Single-hop | Multi-hop |
|---------------------------|---------------------------|---------|-------------------|------------|-----------|
| **Embedding**             | Ubah teks â†’ vektor        | 158-176 | `/api/embeddings` | âœ… 1x      | âœ… 4x     |
| **Query Decomposition**   | Pecah query â†’ 4 sub-query | 491-543 | `/api/chat`       | âŒ         | âœ… 1x     |
| **Answer Generation**     | Generate jawaban          | 548-565 | `/api/chat`       | âœ… 1x      | âœ… 1x     |

**Model:** llama3:8b via Ollama (localhost:11434)

---

## Hybrid Retrieval (RAG)

| Komponen          | Fungsi                                | Baris         | Single-hop | Multi-hop |
|-------------------|---------------------------------------|---------------|------------|-----------|
| **Vector Search** | Cari semantic similarity via Qdrant   | 439-448       | âœ… 1x      | âœ… 4x     |
| **BM25 Search**   | Cari keyword match                    | 450-467       | âœ… 1x      | âœ… 4x     |
| **RRF Fusion**    | Gabungkan ranking                     | 311-316, 469  | âœ… 1x      | âœ… 4x     |

**Database:** Qdrant (localhost:6333)                                                                           

---

## Anti-Halusinasi

| Mekanisme             | Baris   |
|-----------------------|---------|
| Strict system prompt  | 733-764 |
| Citation validation   | 338-354 |
| Retry mechanism       | 782-796 |
| Fallback citations    | 356-374 |

---

# ğŸ—£ï¸ Script Penjelasan ke Dosen

**"Pak, alur program saya ada 2 fase besar:"**

## Fase 1: Ingestion (Sekali saat upload)
1. **User upload PDF** (baris 637)
2. **Parse PDF** â†’ extract teks dengan `pdf-parse` (baris 674)
3. **Smart Chunking** â†’ potong per paragraf, max 800 char (baris 81-156)
4. **Embedding** â†’ LLM ubah setiap chunk jadi vektor 4096 dimensi (baris 158-176)
5. **Store ke Qdrant** â†’ simpan vektor + teks (baris 691-695)
6. **Build BM25 cache** â†’ untuk keyword search (baris 191-243)

## Fase 2A: Single-hop Query
1. **Embed pertanyaan** â†’ jadi vektor (baris 437)
2. **Vector Search** â†’ cari vektor mirip di Qdrant (baris 439-448)
3. **BM25 Search** â†’ cari keyword match (baris 450-467)
4. **RRF Fusion** â†’ gabungkan hasil keduanya (baris 469)
5. **LLM Generate** â†’ jawab dari context dengan sitasi (baris 768-780)
6. **Validate** â†’ pastikan ada sitasi, retry jika perlu (baris 782-796)

## Fase 2B: Multi-hop Query
1. **Decompose** â†’ LLM pecah jadi 4 sub-query (baris 491-543)
2. **Parallel Retrieve** â†’ 4x hybrid search bersamaan (baris 834-839)
3. **Merge + Deduplicate** â†’ gabungkan hasil unique (baris 841-862)
4. **LLM Synthesis** â†’ jawab komprehensif dari semua context (baris 907-920)

---

## âœ… Checklist Pemahaman

- [ ] Bisa jelaskan Fase 1 (Ingestion)
- [ ] Bisa jelaskan Fase 2A (Single-hop)
- [ ] Bisa jelaskan Fase 2B (Multi-hop)
- [ ] Bisa tunjukkan baris kode untuk setiap step
- [ ] Bisa gambar diagram jika diminta
